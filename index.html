<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>APENAS UMA MOLDURA</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100%;
      width: 100%;
    }

    #camera-wrap {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: black;
    }

    video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: black;
    }

    #frame {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #buttons {
      position: fixed;
      bottom: 25px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 20;
    }

    .icon-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      cursor: pointer;
      object-fit: cover;
      background: none;
      border: none;
      padding: 0;
      transition: transform 0.15s;
    }

    .icon-btn:active {
      transform: scale(0.9);
    }

    /* ===== PREVIEW ===== */
    #preview-container {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      z-index: 40;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }

    #photo-preview {
      width: 85vw;
      max-width: 360px;
      border-radius: 14px;
      border: 3px solid white;
    }

    .preview-btn {
      width: 220px;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }

    #save-btn {
      background: #4CAF50;
      color: white;
    }

    #retry-btn {
      background: white;
      color: black;
    }

    #ios-tip {
      color: #fff;
      font-size: 13px;
      opacity: 0.9;
      text-align: center;
      max-width: 90%;
      display: none;
    }
  </style>
</head>
<body>

  <div id="camera-wrap">
    <video id="video" autoplay playsinline muted></video>
    <img id="frame" src="moldura.png">
  </div>

  <div id="buttons">
    <img id="switchBtn" class="icon-btn" src="trocarcamera.png">
    <img id="snapBtn" class="icon-btn" src="tirarfoto.png">
  </div>

  <!-- PREVIEW -->
  <div id="preview-container">
    <img id="photo-preview">
    <button id="save-btn" class="preview-btn">Salvar foto</button>
    <button id="retry-btn" class="preview-btn">Tirar outra</button>
    <div id="ios-tip">
      No iPhone: toque e segure a imagem e escolha “Salvar na Fototeca”
    </div>
  </div>

  <a id="download" download="foto-moldura.png" style="display:none"></a>

  <script>
    const video = document.getElementById("video");
    const frame = document.getElementById("frame");
    const snapBtn = document.getElementById("snapBtn");
    const switchBtn = document.getElementById("switchBtn");
    const buttons = document.getElementById("buttons");

    const previewContainer = document.getElementById("preview-container");
    const photoPreview = document.getElementById("photo-preview");
    const saveBtn = document.getElementById("save-btn");
    const retryBtn = document.getElementById("retry-btn");
    const iosTip = document.getElementById("ios-tip");
    const download = document.getElementById("download");

    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    let stream = null;
    let usingFront = true;

    function waitForVideoReady() {
      return new Promise(resolve => {
        if (video.readyState >= 2 && video.videoWidth > 0) resolve();
        else video.onloadedmetadata = () => resolve();
      });
    }

    async function startCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: usingFront ? "user" : "environment" }
      });

      video.srcObject = stream;
      video.style.transform = usingFront ? "scaleX(-1)" : "scaleX(1)";
      await waitForVideoReady();
    }

    switchBtn.onclick = () => {
      usingFront = !usingFront;
      startCamera();
    };

    snapBtn.onclick = async () => {
      await waitForVideoReady();

      const vw = video.videoWidth;
      const vh = video.videoHeight;

      const canvas = document.createElement("canvas");
      canvas.width = 720;
      canvas.height = 1280;
      const ctx = canvas.getContext("2d");

      ctx.save();
      if (usingFront) {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }

      const vr = vw / vh;
      const tr = canvas.width / canvas.height;
      let sx, sy, sw, sh;

      if (vr > tr) {
        sh = vh;
        sw = sh * tr;
        sx = (vw - sw) / 2;
        sy = 0;
      } else {
        sw = vw;
        sh = sw / tr;
        sx = 0;
        sy = (vh - sh) / 2;
      }

      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
      ctx.restore();
      ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);

      const img = canvas.toDataURL("image/png");
      photoPreview.src = img;

      previewContainer.style.display = "flex";
      buttons.style.display = "none";
      iosTip.style.display = isIOS ? "block" : "none";
    };

    saveBtn.onclick = () => {
      download.href = photoPreview.src;
      download.click();
    };

    retryBtn.onclick = () => {
      previewContainer.style.display = "none";
      buttons.style.display = "flex";
    };

    startCamera();
  </script>

</body>
</html>
